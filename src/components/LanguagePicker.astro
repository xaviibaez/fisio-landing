---
import { languages } from '../i18n/ui';
import { getLangFromUrl } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
let currentPath = Astro.url.pathname.replace(/^\/(ca|es|en)/, '') || '/';

// Translate paths based on target language
const translatePath = (path: string, targetLang: string) => {
  // Service paths
  const serviceMatch = path.match(/\/(serveis|servicios|services)\/(.+)/);
  if (serviceMatch) {
    const slug = serviceMatch[2];
    const serviceWord = targetLang === 'ca' ? 'serveis' : targetLang === 'es' ? 'servicios' : 'services';
    return `/${serviceWord}/${slug}`;
  }
  
  // About us page
  if (path === '/nosaltres' || path === '/nosotros' || path === '/about-us') {
    return targetLang === 'ca' ? '/nosaltres' : targetLang === 'es' ? '/nosotros' : '/about-us';
  }
  
  // Gallery page
  if (path === '/galeria' || path === '/gallery') {
    return targetLang === 'en' ? '/gallery' : '/galeria';
  }
  
  return path;
};
---

<div class="relative inline-block text-left language-picker">
  <button
    type="button"
    class="language-button inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 hover:text-primary-600 transition rounded-lg hover:bg-gray-100"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
    </svg>
    <span class="uppercase">{lang}</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <div
    class="language-menu hidden absolute right-0 z-10 mt-2 w-40 origin-top-right rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
    role="menu"
    aria-orientation="vertical"
  >
    <div class="py-1" role="none">
      {Object.entries(languages).map(([code, name]) => {
        const translatedPath = translatePath(currentPath, code);
        const href = code === 'ca' ? translatedPath : `/${code}${translatedPath}`;
        return (
          <a
            href={href}
            class={`block px-4 py-2 text-sm hover:bg-gray-100 transition ${
              lang === code ? 'bg-primary-50 text-primary-700 font-semibold' : 'text-gray-700'
            }`}
            role="menuitem"
          >
            {name}
          </a>
        );
      })}
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.language-picker').forEach((picker) => {
    const button = picker.querySelector('.language-button');
    const menu = picker.querySelector('.language-menu');

    button?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = menu?.classList.contains('hidden');
      
      // Cerrar todos los otros menús abiertos
      document.querySelectorAll('.language-menu').forEach((m) => {
        if (m !== menu) {
          m.classList.add('hidden');
        }
      });
      
      if (isHidden) {
        menu?.classList.remove('hidden');
        button?.setAttribute('aria-expanded', 'true');
      } else {
        menu?.classList.add('hidden');
        button?.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // Cerrar menús cuando se hace clic fuera
  document.addEventListener('click', () => {
    document.querySelectorAll('.language-menu').forEach((menu) => {
      menu.classList.add('hidden');
    });
    document.querySelectorAll('.language-button').forEach((button) => {
      button.setAttribute('aria-expanded', 'false');
    });
  });
</script>
