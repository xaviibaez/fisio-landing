---
import LanguagePicker from './LanguagePicker.astro';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/utils';
import siteSettings from '../data/site-settings.json';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const currentPath = Astro.url.pathname;
---

<header class="bg-white shadow-sm sticky top-0 z-50">
  <nav class="container mx-auto px-4 py-4">
    <div class="flex items-center justify-between">
      <a href={getLocalizedPath('/', lang)} class="text-2xl font-heading font-bold text-primary-600 flex items-center gap-2">
        {siteSettings.site.logo ? (
          <img src={siteSettings.site.logo} alt={siteSettings.site.name} class="h-8 md:h-10 w-auto" />
        ) : (
          <span>{siteSettings.site.name}</span>
        )}
      </a>
      
      <!-- Desktop Menu -->
      <ul class="hidden md:flex items-center gap-8">
        <li><a href={getLocalizedPath('/#servicios', lang)} class="nav-link text-gray-700 hover:text-primary-600 transition pb-1" data-section="servicios">{t('nav.services')}</a></li>
        <li><a href={getLocalizedPath('/#nosotros', lang)} class="nav-link text-gray-700 hover:text-primary-600 transition pb-1" data-section="nosotros">{t('nav.about')}</a></li>
        <li><a href={getLocalizedPath('/#contacto', lang)} class="nav-link text-gray-700 hover:text-primary-600 transition pb-1" data-section="contacto">{t('nav.contact')}</a></li>
        <li><a href={getLocalizedPath('/nosaltres', lang)} class={`nav-link transition pb-1 ${currentPath.includes('/nosaltres') || currentPath.includes('/nosotros') || currentPath.includes('/about-us') ? 'text-primary-600 font-semibold border-b-2 border-primary-500' : 'text-gray-700 hover:text-primary-600'}`} data-page="nosaltres">{t('nav.aboutUs')}</a></li>
        <li><a href={getLocalizedPath('/blog', lang)} class={`nav-link transition pb-1 ${currentPath.includes('/blog') ? 'text-primary-600 font-semibold border-b-2 border-primary-500' : 'text-gray-700 hover:text-primary-600'}`} data-page="blog">{t('nav.blog')}</a></li>
        <li>
          <LanguagePicker />
        </li>
        <li>
          <a href={getLocalizedPath('/#contacto', lang)} class="bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition-all transform hover:scale-105">
            {t('nav.bookAppointment')}
          </a>
        </li>
      </ul>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-button" class="md:hidden text-gray-700 hover:text-primary-600" aria-label="Toggle menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden mt-4 pb-4">
      <ul class="flex flex-col gap-4">
        <li><a href={getLocalizedPath('/#servicios', lang)} class="nav-link-mobile block text-gray-700 hover:text-primary-600 transition" data-section="servicios">{t('nav.services')}</a></li>
        <li><a href={getLocalizedPath('/#nosotros', lang)} class="nav-link-mobile block text-gray-700 hover:text-primary-600 transition" data-section="nosotros">{t('nav.about')}</a></li>
        <li><a href={getLocalizedPath('/#contacto', lang)} class="nav-link-mobile block text-gray-700 hover:text-primary-600 transition" data-section="contacto">{t('nav.contact')}</a></li>
        <li><a href={getLocalizedPath('/nosaltres', lang)} class={`nav-link-mobile block transition ${currentPath.includes('/nosaltres') || currentPath.includes('/nosotros') || currentPath.includes('/about-us') ? 'text-primary-600 font-semibold' : 'text-gray-700 hover:text-primary-600'}`} data-page="nosaltres">{t('nav.aboutUs')}</a></li>
        <li><a href={getLocalizedPath('/blog', lang)} class={`nav-link-mobile block transition ${currentPath.includes('/blog') ? 'text-primary-600 font-semibold' : 'text-gray-700 hover:text-primary-600'}`} data-page="blog">{t('nav.blog')}</a></li>
        <li class="flex justify-center">
          <LanguagePicker />
        </li>
        <li>
          <a href={getLocalizedPath('/#contacto', lang)} class="block text-center bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition">
            {t('nav.bookAppointment')}
          </a>
        </li>
      </ul>
    </div>
  </nav>
</header>

<script>
  const button = document.getElementById('mobile-menu-button');
  const menu = document.getElementById('mobile-menu');

  button?.addEventListener('click', () => {
    menu?.classList.toggle('hidden');
  });

  // Scroll Spy - detectar sección activa
  function updateActiveSection() {
    const sections = ['servicios', 'nosotros', 'contacto'];
    const navLinks = document.querySelectorAll('.nav-link[data-section]');
    const navLinksMobile = document.querySelectorAll('.nav-link-mobile[data-section]');
    
    // Solo ejecutar en la página principal
    const isHomePage = window.location.pathname === '/' || 
                       window.location.pathname === '/es/' || 
                       window.location.pathname === '/en/' ||
                       window.location.pathname === '/es' || 
                       window.location.pathname === '/en';
    
    if (!isHomePage) return;

    let currentSection = '';
    const scrollPosition = window.scrollY + 100; // offset para el header sticky

    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        const sectionTop = section.offsetTop;
        const sectionHeight = section.offsetHeight;
        
        if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
          currentSection = sectionId;
        }
      }
    });

    // Actualizar clases en desktop
    navLinks.forEach(link => {
      const linkSection = link.getAttribute('data-section');
      if (linkSection === currentSection) {
        link.classList.remove('text-gray-700');
        link.classList.add('text-primary-600', 'font-semibold', 'border-b-2', 'border-primary-500');
      } else {
        link.classList.remove('text-primary-600', 'font-semibold', 'border-b-2', 'border-primary-500');
        link.classList.add('text-gray-700');
      }
    });

    // Actualizar clases en mobile
    navLinksMobile.forEach(link => {
      const linkSection = link.getAttribute('data-section');
      if (linkSection === currentSection) {
        link.classList.remove('text-gray-700');
        link.classList.add('text-primary-600', 'font-semibold', 'bg-primary-50', 'rounded-md');
      } else {
        link.classList.remove('text-primary-600', 'font-semibold', 'bg-primary-50', 'rounded-md');
        link.classList.add('text-gray-700');
      }
    });
  }

  // Ejecutar al hacer scroll y al cargar
  window.addEventListener('scroll', updateActiveSection);
  window.addEventListener('load', updateActiveSection);
</script>
